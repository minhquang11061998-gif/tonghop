@page "/exam-room"
@using System.Text.Json
@using Blazor.Data
@using DataBase.DTOs
@using global::Data.DTOs
@using System.Net.Http.Json
@layout AdminLayout
@inject HttpClient client
@inject IHttpClientFactory clientFactory
@inject IJSRuntime Jsruntime
@inject NavigationManager navigate


<div class="container-fluid mt-3">
    <!-- Header Section -->
    @*  <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-3">
    <h2 class="text-primary">Quản lý phòng thi</h2>
    <div>
    <button class="btn btn-primary me-2" @onclick="()=>showRoom(ModalTypeRoom.Add)">
    <i class="bi bi-plus-circle"></i> Tạo mới
    </button>
    <button class="btn btn-warning me-2" @onclick="()=>showRoom(ModalTypeRoom.Edit)" disabled="@(selectedRoomId == Guid.Empty)">
    <i class="bi bi-pencil"></i> Chỉnh sửa
    </button>
    <button class="btn btn-danger" @onclick="deleteRoom" disabled="@(selectedRoomId == Guid.Empty)">
    <i class="bi bi-trash"></i> Xóa
    </button>
    </div>
    </div> *@

    <!-- Folder Structure -->
    <div class="border d-flex">
        <!-- Rooms Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-primary">
                    <tr>
                        <th style="width: 50px;">
                            <input type="checkbox" @onchange="ToggleSelectAll">
                        </th>
                        <th>Tên bài thi</th>
                        <th>Mã vào thi</th>
                        <th>Phòng thi</th>
                        <th>Môn</th>
                        <th>Thời gian bắt đầu</th>
                        <th>Thời gian kết thúc</th>
                        <th>Giáo viên coi thi 1</th
                        <th>Giáo viên coi thi 2</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (filteredExamRooms.Any())
                    {
                        @foreach (var examroom in filteredExamRooms)
                        {
                            <tr class="@(selectedRoomExamId == examroom.Id ? "table-info" : "")">
                                <td>
                                    <input type="checkbox" checked="@(selectedRoomExamId == examroom.Id)" @onchange="() => SelectExamRoom(examroom.Id)">
                                </td>
                                <td>@examroom.Name</td>
                                <td>@examroom.CodeTest</td>
                                <td>@examroom.Nameroom</td>
                                <td>@examroom.NameSubject</td>
                                <td>@examroom.StartTime</td>
                                <td>@examroom.EndTime</td>
                                <td>@examroom.NameTeacher1</td>
                                <td>@examroom.NameTeacher2</td>
                                <td>@examroom.Status</td>
                                <td>
                                    <button class="btn btn-info btn-sm" @onclick="()=>OpenCreateExamModal()">
                                        <i class="bi bi-eye"></i> Tạo ca thi
                                    </button>
                                          <button class="btn btn-info btn-sm" @onclick="()=>OpenDetailExamModal(idtest)">
                                        <i class="bi bi-eye"></i> Xem chi tiết
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted">Không tìm thấy phòng thi nào</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button class="btn btn-secondary" @onclick="PreviousPage" disabled="@(!CanGoPrevious)">
                <i class="bi bi-arrow-left"></i> Trước
            </button>
            <span>Trang @CurrentPage / @TotalPages</span>
            <button class="btn btn-secondary" @onclick="NextPage" disabled="@(!CanGoNext)">
                <i class="bi bi-arrow-right"></i> Sau
            </button>
        </div>
    </div>

</div>


<!-- Modal for Creating Exam Session -->
<div class="modal fade @(isCreateExamModalVisible ? "show" : "")" tabindex="-1" style="display:@(isCreateExamModalVisible ? "block" : "none");">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tạo ca thi</h5>
                <button type="button" class="btn-close" @onclick="CloseCreateExamModal"></button>
            </div>
            <div class="modal-body">
                
                        <div>
                                 <div >
                                     <select class="form-select" @bind="idtest">
                                         <option value="@Guid.Empty">Chọn bài thi</option>

                                            @foreach (var item in testList)
                                            {
                                                 <option value="@item.Id">@item.Name</option>
                                            }
                           
                                     </select>
                                 </div>
                                <div class="mt-2">
                                    <label for="easyCount">Số câu dễ:</label>
                                    <input type="number" id="easyCount" @bind="easyCount" min="0" class="form-control mb-2" />

                                    <label for="mediumCount">Số câu trung bình:</label>
                                    <input type="number" id="mediumCount" @bind="mediumCount" min="0" class="form-control mb-2" />

                                    <label for="hardCount">Số câu khó:</label>
                                    <input type="number" id="hardCount" @bind="hardCount" min="0" class="form-control mb-2" />

                                    <label for="veryHardCount">Số câu nâng cao:</label>
                                    <input type="number" id="veryHardCount" @bind="veryHardCount" min="0" class="form-control mb-2" />

                                    <button class="btn btn-primary mt-2" @onclick="CreateExam"> Tạo ca thi</button>
                            
                                </div>
                                
                        </div>
                    
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCreateExamModal">Đóng</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal for Viewing Details -->
<div class="modal fade @(isDetailModalVisible ? "show" : "")" tabindex="-1" style="display:@(isDetailModalVisible ? "block" : "none");">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết bài thi</h5>
                <button type="button" class="btn-close" @onclick="CloseDtailExamModal"></button>
            </div>
            <div class="modal-body">
                            @foreach (var item in detailDTOs)
                            {
                                <h2 class="title">SỞ GD & ĐT THANH HÓA</h2>
                                <h3 class="school-name">TRƯỜNG THPT NGUYỄN TRÃI</h3>
                                <h4 class="year">NĂM HỌC 2017 - 2018</h4>

                                <h4 class="subject">MÔN: @item.NameSubject</h4>
                                <h5 class="time">Thời gian làm bài: @item.time phút</h5>
                                <h6 class="code">Mã đề thi: @item.CodeTescode</h6>

                                <div class="student-info">
                                    <span>Họ, tên sinh viên: ............................................</span><br />
                                    <span>Số báo danh: .................................................</span>
                                </div>
                                <div class="content">
                                    @foreach (var question in item.NameQuestion)
                                    {
                                        <h5>Câu @(item.NameQuestion.IndexOf(question) + 1): @question.QuestionName</h5>
                                        <ol type="A" class="d-flex justify-content-md-evenly p-2">
                                            @if (question.Type == 1 || question.Type == 2)
                                            {
                                                foreach (var answer in question.Answers)
                                                {
                                                    <li>@answer.Answer</li>
                                                }
                                            }
                                            else if (question.Type == 3)
                                            {
                                                <li>Đúng</li>
                                                <li>Sai</li>
                                            }
                                            else if (question.Type == 4)
                                            {
                                                @foreach (var answer in question.Answers)
                                                {
                                                    <p><strong>Đáp án:</strong> @answer.Answer</p>
                                                }
                                            }
                                        </ol>
                                    }

                                </div>
                            }
                        
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseDtailExamModal">Đóng</button>
            </div>
        </div>
    </div>
</div>
@code {
    private string searchRoom { get; set; } = string.Empty;
    private int CurrentPage { get; set; } = 1;
    private int ItemsPerPage { get; set; } = 5;
    private Guid selectedRoomExamId;
    private bool isExamRoomModalVisible = false;
    private GetAllExamCaThiDTO ExamroomDTO = new GetAllExamCaThiDTO();
    private List<GetAllExamCaThiDTO> ListExamroomDTOs = new List<GetAllExamCaThiDTO>();
    // Các biến và danh sách cần thiết
    private List<DetailDTO> detailDTOs = new List<DetailDTO>();
    private List<TestQuestion_TestQuestionAnswersDTO> selectedQuestions = new List<TestQuestion_TestQuestionAnswersDTO>();
    private List<TestDTO> testList = new List<TestDTO>();
    private TestDTO TestDTO = new TestDTO();
    private Guid? selectedTestId = null;
    private bool isLoading = false;
    private Guid idtest;
    private int easyCount;
    private int mediumCount;
    private int hardCount;
    private int veryHardCount;

    private IEnumerable<GetAllExamCaThiDTO> filteredExamRooms => ListExamroomDTOs
       .Where(r => string.IsNullOrEmpty(searchRoom) || r.Name.Contains(searchRoom, StringComparison.OrdinalIgnoreCase))
       .Skip((CurrentPage - 1) * ItemsPerPage)
       .Take(ItemsPerPage);

    private int TotalPages => (int)Math.Ceiling((double)filteredExamRooms.Count() / ItemsPerPage);
    private bool CanGoPrevious => CurrentPage > 1;
    private bool CanGoNext => CurrentPage < TotalPages;
    private bool isCreateExamModalVisible = false;
    private bool isDetailModalVisible = false;

    // Phương thức xử lý sự kiện nhấn nút "Tạo ca thi"
    private async Task CreateExam()
    {
        isLoading = true; // Bắt đầu tải
        try
        {

            // Gửi yêu cầu tạo câu hỏi ngẫu nhiên

            var response = await client.PostAsJsonAsync($"https://localhost:7046/api/TestQuestion/randomize-questions-for-test-codes?testId={idtest}&easyCount={easyCount}&mediumCount={mediumCount}&hardCount={hardCount}&veryHardCount={veryHardCount}", selectedQuestions);

            if (response.IsSuccessStatusCode)
            {
                await ShowSuccessMessage("Thêm dữ liệu thành công!");

                // Tải lại chi tiết bài thi sau khi thêm thành công
                await LoadDetailTest(idtest);

            }
            else
            {
                await ShowErrorMessage($"Có lỗi xảy ra. Mã lỗi: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            await ShowErrorMessage($"Có lỗi xảy ra: {ex.Message}");
        }
        finally
        {
            isLoading = false; // Kết thúc tải
        }
    }

    // Các phương thức khác vẫn giữ nguyên như bạn đã viết
    protected override async Task OnInitializedAsync()
    {
        await LoadExamRooms();
        await LoadTestList();
    }

    private async Task LoadExamRooms()
    {
        ListExamroomDTOs = await client.GetFromJsonAsync<List<GetAllExamCaThiDTO>>("https://localhost:7046/api/Exam/get-all-exam-cathi");
    }

    private async Task LoadTestList()
    {
        var client = clientFactory.CreateClient("Get");
        var url = "https://localhost:7046/api/Test/get-all-test-CATHI";
        testList = await client.GetFromJsonAsync<List<TestDTO>>(url);
    }

    private async Task LoadDetailTest(Guid id)
    {
        var client = clientFactory.CreateClient("Get");
        var url = $"https://localhost:7046/api/TestQuestion/Get-testcodes-by-testid?testId={id}";
        detailDTOs = await client.GetFromJsonAsync<List<DetailDTO>>(url);
    }

    private void ToggleTest(Guid id)
    {
        selectedTestId = selectedTestId == id ? null : id;
    }

    private void PreviousPage()
    {
        if (CanGoPrevious)
        {
            CurrentPage--;
        }
    }

    private void NextPage()
    {
        if (CanGoNext)
        {
            CurrentPage++;
        }
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        var isChecked = (bool)e.Value;
        selectedRoomExamId = isChecked ? ListExamroomDTOs.FirstOrDefault()?.Id ?? Guid.Empty : Guid.Empty;
    }

    private void SelectExamRoom(Guid roomId)
    {
        selectedRoomExamId = selectedRoomExamId == roomId ? Guid.Empty : roomId;
    }


    private async Task ShowSuccessMessage(string message)
    {
        await Jsruntime.InvokeVoidAsync("Swal.fire", new
        {
            title = "Thành công!",
            text = message,
            icon = "success",
            confirmButtonText = "OK"
        });
    }

    private async Task ShowErrorMessage(string message)
    {
        await Jsruntime.InvokeVoidAsync("Swal.fire", new
        {
            title = "Thất bại!",
            text = message,
            icon = "error",
            confirmButtonText = "OK"
        });
    }

    private void OpenCreateExamModal()
    {
        isCreateExamModalVisible = true;
    }
    private void CloseCreateExamModal()
    {
        isCreateExamModalVisible = false;
    }
    private void OpenDetailExamModal(Guid id)
    {
        id = idtest;
        isDetailModalVisible = true;
    }
    private void CloseDtailExamModal()
    {
        isDetailModalVisible = false;
    }
}

